## 9. 계층형 질의
### 9. 계층형 질의
- **START WITH**: 계층 시작점
- **CONNECT BY**: 부모-자식 관계 정의
- **PRIOR**: 부모/자식 방향 지정
- **LEVEL**: 계층 깊이
- **CONNECT_BY_ISLEAF, CONNECT_BY_ISCYCLE, SYS_CONNECT_BY_PATH, CONNECT_BY_ROOT**: 계층 관련 가상 컬럼/함수

```
-- 샘플 테이블 생성
CREATE TABLE employees (
  emp_id NUMBER PRIMARY KEY,
  emp_name VARCHAR2(20),
  manager_id NUMBER,
  salary NUMBER
);

INSERT INTO employees VALUES (1, 'CEO', NULL, 10000);
INSERT INTO employees VALUES (2, 'CTO', 1, 8000);
INSERT INTO employees VALUES (3, 'CFO', 1, 7500);
INSERT INTO employees VALUES (4, '개발팀장', 2, 6000);
INSERT INTO employees VALUES (5, '재무팀장', 3, 5500);
INSERT INTO employees VALUES (6, '개발자A', 4, 4000);
INSERT INTO employees VALUES (7, '재무담당A', 5, 3500);

-- 1. 기본 계층형 쿼리
SELECT 
  LPAD(' ', (LEVEL-1)*4) || emp_name AS 조직도,
  LEVEL AS 계층,
  CONNECT_BY_ISLEAF AS 말단여부,
  SYS_CONNECT_BY_PATH(emp_name, ' → ') AS 경로
FROM employees
START WITH manager_id IS NULL       -- 최상위 루트 노드 지정
CONNECT BY PRIOR emp_id = manager_id  -- 부모-자식 관계 정의
ORDER SIBLINGS BY emp_name;

/*
결과:
조직도           | 계층 | 말단여부 | 경로
----------------|-----|---------|-------------------
CEO             | 1   | 0       | → CEO
    CTO         | 2   | 0       | → CEO → CTO
        개발팀장 | 3   | 0       | → CEO → CTO → 개발팀장
            개발자A |4|1       | → CEO → CTO → 개발팀장 → 개발자A
    CFO         | 2   | 0       | → CEO → CFO
        재무팀장 | 3   | 0       | → CEO → CFO → 재무팀장
            재무담당A |4|1     | → CEO → CFO → 재무팀장 → 재무담당A
*/

-- 2. PRIOR 방향 전환 (하위 → 상위 탐색)
SELECT emp_name, manager_id, LEVEL
FROM employees
START WITH emp_id = 6              -- 개발자A부터 시작
CONNECT BY PRIOR manager_id = emp_id;  -- 자식 → 부모 방향

/*
결과:
EMP_NAME | MANAGER_ID | LEVEL
개발자A   | 4          | 1
개발팀장  | 2          | 2
CTO      | 1          | 3
CEO      | NULL       | 4
*/

-- 3. CONNECT_BY_ROOT (루트 노드 정보 추출)
SELECT 
  emp_name,
  CONNECT_BY_ROOT emp_name AS 최상위관리자,
  LEVEL
FROM employees
CONNECT BY PRIOR emp_id = manager_id;

-- 4. CONNECT_BY_ISCYCLE (순환 구조 감지)
-- 순환 구조 데이터 추가 (CTO가 CEO의 매니저로 지정)
UPDATE employees SET manager_id = 1 WHERE emp_id = 2;

SELECT 
  emp_name,
  CONNECT_BY_ISCYCLE AS 순환여부,
  SYS_CONNECT_BY_PATH(emp_name, ' → ') AS 경로
FROM employees
CONNECT BY NOCYCLE PRIOR emp_id = manager_id;  -- NOCYCLE 필수

```