## 7. 윈도우 함수
### 7. 윈도우 함수
- **OVER**: 파티션별, 정렬 기준, 범위 지정
- **RANK, DENSE_RANK, ROW_NUMBER**: 순위 함수
- **LAG, LEAD**: 이전/다음 값 참조
- **FIRST_VALUE, LAST_VALUE**: 첫/마지막 값
- **NTILE**: 그룹 분할
- **RATIO_TO_REPORT, CUME_DIST, PERCENT_RANK**: 비율, 누적분포

```
-- 샘플 테이블 생성 및 데이터 입력
CREATE TABLE emp (
  emp_id NUMBER,
  dept_id NUMBER,
  salary NUMBER
);

INSERT INTO emp VALUES (1, 10, 3000);
INSERT INTO emp VALUES (2, 10, 3500);
INSERT INTO emp VALUES (3, 20, 4000);
INSERT INTO emp VALUES (4, 20, 4500);
INSERT INTO emp VALUES (5, 20, 4500);
INSERT INTO emp VALUES (6, 30, 5000);

-- 1. OVER(): 파티션/정렬/범위 지정
SELECT 
  emp_id,
  salary,
  SUM(salary) OVER (PARTITION BY dept_id) AS dept_total,
  AVG(salary) OVER (ORDER BY salary ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS moving_avg
FROM emp;

-- 2. 순위 함수
SELECT 
  emp_id,
  salary,
  RANK() OVER (ORDER BY salary DESC) AS rank,          -- 공동 순위 시 다음 순위 건너뜀 (1,2,2,4)
  DENSE_RANK() OVER (ORDER BY salary DESC) AS dense_rank, -- 공동 순위 시 연속 순위 (1,2,2,3)
  ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_num  -- 고유 순번 부여
FROM emp;

-- 3. LAG/LEAD: 이전/다음 행 값 참조
SELECT 
  emp_id,
  salary,
  LAG(salary, 1, 0) OVER (ORDER BY salary) AS prev_salary,  -- 이전 행 값 (기본값 0)
  LEAD(salary) OVER (ORDER BY salary) AS next_salary        -- 다음 행 값
FROM emp;

-- 4. FIRST_VALUE/LAST_VALUE: 첫/마지막 값
SELECT 
  emp_id,
  dept_id,
  salary,
  FIRST_VALUE(salary) OVER (PARTITION BY dept_id ORDER BY salary) AS first_in_dept,
  LAST_VALUE(salary) OVER (PARTITION BY dept_id ORDER BY salary ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS last_in_dept
FROM emp;

-- 5. NTILE: 데이터를 그룹으로 분할
SELECT 
  emp_id,
  salary,
  NTILE(2) OVER (ORDER BY salary) AS ntile_group  -- 데이터를 2개의 그룹으로 분할
FROM emp;

-- 6. 비율 함수
SELECT 
  emp_id,
  salary,
  RATIO_TO_REPORT(salary) OVER () AS ratio,          -- 전체 대비 비율
  CUME_DIST() OVER (ORDER BY salary) AS cume_dist,   -- 누적 분포
  PERCENT_RANK() OVER (ORDER BY salary) AS percent_rank  -- 백분율 순위
FROM emp;
```

```
-- RANK/DENSE_RANK/ROW_NUMBER 결과
EMP_ID | SALARY | RANK | DENSE_RANK | ROW_NUM
----------------------------------------------
6      | 5000   | 1    | 1          | 1
5      | 4500   | 2    | 2          | 2
4      | 4500   | 2    | 2          | 3
3      | 4000   | 4    | 3          | 4
2      | 3500   | 5    | 4          | 5
1      | 3000   | 6    | 5          | 6

-- NTILE(2) 결과
EMP_ID | SALARY | NGROUP
-------------------------
1      | 3000   | 1
2      | 3500   | 1
3      | 4000   | 1
4      | 4500   | 2
5      | 4500   | 2
6      | 5000   | 2
```